name: Deploy Infrastructure (Bicep)

on:
    workflow_dispatch:

permissions:
    contents: read
    id-token: write

# Deploy Infrastructure (Bicep)
name: Deploy Infrastructure (Bicep)

on:
    workflow_dispatch:

permissions:
    contents: read
    id-token: write

jobs:
    deploy-infra:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Azure Login (OIDC)
                uses: azure/login@v2
                with:
                    client-id: ${{ secrets.AZURE_CLIENT_ID }}
                    tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                    subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
            - name: Deploy Bicep
                uses: azure/arm-deploy@v2
                with:
                    scope: resourcegroup
                    resourceGroupName: ${{ secrets.AZURE_RG }}
                    template: infra/main.bicep
                    parameters: infra/params.prod.json
    deploy-infra:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

              uses: azure/login@v2
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Deploy Bicep
              uses: azure/arm-deploy@v2
              with:
                  scope: resourcegroup
                  resourceGroupName: ${{ secrets.AZURE_RG }}
                  template: infra/main.bicep
                  parameters: infra/params.prod.json

                        - name: Azure Login (OIDC)
                            uses: azure/login@v2
                            with:
                                client-id: ${{ secrets.AZURE_CLIENT_ID }}
                                tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                                subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

                        - name: Deploy Bicep
                            uses: azure/arm-deploy@v2
                            with:
                                scope: resourcegroup
                                resourceGroupName: ${{ secrets.AZURE_RG }}
                                template: infra/main.bicep
                                parameters: infra/params.prod.json

                            with:
                                    client-id: ${{ secrets.AZURE_CLIENT_ID }}
                                    tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                                    subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

                        - name: Deploy Bicep
                            uses: azure/arm-deploy@v2
                            with:
                                    scope: resourcegroup
                                    resourceGroupName: ${{ secrets.AZURE_RG }}
                                    template: infra/main.bicep
                                    parameters: infra/params.prod.json
